name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target universal-apple-darwin"
            rust_targets: "aarch64-apple-darwin,x86_64-apple-darwin"
          - platform: ubuntu-22.04
            args: ""
            rust_targets: ""
          - platform: windows-latest
            args: "--bundles all"
            rust_targets: ""
          - platform: windows-latest
            args: "--target aarch64-pc-windows-msvc --bundles all"
            rust_targets: "aarch64-pc-windows-msvc"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'App v__VERSION__'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  generate-updater-json:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Generate latest.json
        uses: actions/github-script@v7
        env:
          TAG_NAME: ${{ github.ref_name }}
        with:
          script: |
            const fs = require('fs');
            const tagName = process.env.TAG_NAME;
            const { owner, repo } = context.repo;

            console.log(`Fetching release for tag ${tagName}...`);
            const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag: tagName });
            const assets = release.data.assets;
            
            const platforms = {};
            
            async function getSignature(assetName) {
              const sigAsset = assets.find(a => a.name === assetName);
              if (!sigAsset) {
                console.log(`Signature file not found for ${assetName}`);
                return null;
              }
              
              try {
                const download = await github.rest.repos.getReleaseAsset({
                  owner,
                  repo,
                  asset_id: sigAsset.id,
                  headers: { accept: 'application/octet-stream' }
                });
                return new TextDecoder().decode(download.data);
              } catch (e) {
                console.error(`Failed to download signature for ${assetName}:`, e);
                return null;
              }
            }

            for (const asset of assets) {
              if (asset.name.endsWith('.sig')) continue;
              
              let platformKey = null;
              if (asset.name.endsWith('.exe')) {
                if (asset.name.includes('aarch64')) platformKey = 'windows-aarch64';
                else platformKey = 'windows-x86_64';
              } else if (asset.name.endsWith('.AppImage')) {
                platformKey = 'linux-x86_64';
              } else if (asset.name.endsWith('.app.tar.gz')) {
                 if (asset.name.includes('aarch64')) platformKey = 'darwin-aarch64';
                 else if (asset.name.includes('x64')) platformKey = 'darwin-x86_64';
                 else if (asset.name.includes('universal')) platformKey = 'darwin-universal'; 
              }
              
              if (platformKey) {
                 const sigName = asset.name + '.sig';
                 const signature = await getSignature(sigName);
                 if (signature) {
                    const entry = {
                       signature: signature.trim(),
                       url: asset.browser_download_url
                    };
                    
                    if (platformKey === 'darwin-universal') {
                        platforms['darwin-aarch64'] = entry;
                        platforms['darwin-x86_64'] = entry;
                    } else {
                        platforms[platformKey] = entry;
                    }
                 }
              }
            }
            
            const latestJson = {
              version: tagName.replace(/^v/, ''),
              notes: release.data.body,
              pub_date: release.data.published_at,
              platforms
            };
            
            console.log('Generated latest.json:', JSON.stringify(latestJson, null, 2));
            fs.writeFileSync('latest.json', JSON.stringify(latestJson, null, 2));
            
            // Check if latest.json already exists (re-run scenario)
            const existingLatest = assets.find(a => a.name === 'latest.json');
            if (existingLatest) {
               await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: existingLatest.id });
            }
            
            await github.rest.repos.uploadReleaseAsset({
              owner,
              repo,
              release_id: release.data.id,
              name: 'latest.json',
              data: fs.readFileSync('latest.json')
            });
